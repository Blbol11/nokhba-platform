#!/bin/bash

# ููู ุชุดุบูู ุณุฑูุน ูููุตุฉ ูุฎุจุฉ
# Quick start script for Nokhba Platform

# ุงูุฃููุงู ููุฑุณุงุฆู
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}       ููุตุฉ ูุฎุจุฉ - Nokhba Platform      ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ุฏุงูุฉ ูุนุฑุถ ุงููุงุฆูุฉ
show_menu() {
    echo -e "${YELLOW}ุงุฎุชุฑ ุฃูุฑุงู:${NC}"
    echo ""
    echo "  1) start     - ุชุดุบูู ุงููุดุฑูุน ูุงููุงู"
    echo "  2) backend   - ุชุดุบูู Backend ููุท"
    echo "  3) frontend  - ุชุดุบูู Frontend ููุท"
    echo "  4) stop      - ุฅููุงู ุฌููุน ุงูุฎูุงุฏู"
    echo "  5) install   - ุชุซุจูุช ุงูุญุฒู"
    echo "  6) mongodb   - ุชุดุบูู MongoDB"
    echo "  7) status    - ุนุฑุถ ุญุงูุฉ ุงูุฎูุงุฏู"
    echo "  8) clean     - ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ"
    echo "  9) help      - ุนุฑุถ ุงููุณุงุนุฏุฉ"
    echo "  0) exit      - ุฎุฑูุฌ"
    echo ""
}

# ุฏุงูุฉ ุชุดุบูู Backend
start_backend() {
    echo -e "${BLUE}๐ ุชุดุบูู Backend...${NC}"
    cd backend
    npm start &
    BACKEND_PID=$!
    echo $BACKEND_PID > /tmp/nokhba_backend.pid
    echo -e "${GREEN}โ Backend ูุนูู ุนูู ุงููููุฐ 5001${NC}"
    echo -e "${GREEN}  http://localhost:5001${NC}"
    cd ..
}

# ุฏุงูุฉ ุชุดุบูู Frontend
start_frontend() {
    echo -e "${BLUE}๐ ุชุดุบูู Frontend...${NC}"
    cd frontend
    BROWSER=none npm start &
    FRONTEND_PID=$!
    echo $FRONTEND_PID > /tmp/nokhba_frontend.pid
    echo -e "${GREEN}โ Frontend ูุนูู ุนูู ุงููููุฐ 3000${NC}"
    echo -e "${GREEN}  http://localhost:3000${NC}"
    cd ..
}

# ุฏุงูุฉ ุฅููุงู ุงูุฎูุงุฏู
stop_servers() {
    echo -e "${YELLOW}โน๏ธ  ุฅููุงู ุงูุฎูุงุฏู...${NC}"

    if [ -f /tmp/nokhba_backend.pid ]; then
        kill $(cat /tmp/nokhba_backend.pid) 2>/dev/null
        rm /tmp/nokhba_backend.pid
        echo -e "${GREEN}โ ุชู ุฅููุงู Backend${NC}"
    fi

    if [ -f /tmp/nokhba_frontend.pid ]; then
        kill $(cat /tmp/nokhba_frontend.pid) 2>/dev/null
        rm /tmp/nokhba_frontend.pid
        echo -e "${GREEN}โ ุชู ุฅููุงู Frontend${NC}"
    fi

    # ุฅููุงู ุฃู ุนูููุงุช node ุชุนูู ุนูู ุงูููุงูุฐ
    lsof -ti:5001 | xargs kill -9 2>/dev/null
    lsof -ti:3000 | xargs kill -9 2>/dev/null
}

# ุฏุงูุฉ ุชุซุจูุช ุงูุญุฒู
install_packages() {
    echo -e "${BLUE}๐ฆ ุชุซุจูุช ุงูุญุฒู...${NC}"

    echo -e "${YELLOW}ุชุซุจูุช ุญุฒู Backend...${NC}"
    cd backend && npm install
    cd ..

    echo -e "${YELLOW}ุชุซุจูุช ุญุฒู Frontend...${NC}"
    cd frontend && npm install
    cd ..

    echo -e "${GREEN}โ ุชู ุชุซุจูุช ุฌููุน ุงูุญุฒู${NC}"
}

# ุฏุงูุฉ ุชุดุบูู MongoDB
start_mongodb() {
    echo -e "${BLUE}๐๏ธ  ุชุดุบูู MongoDB...${NC}"

    if command -v mongod &> /dev/null; then
        mongod --dbpath=/usr/local/var/mongodb &
        echo -e "${GREEN}โ MongoDB ูุนูู${NC}"
    elif brew services list | grep mongodb-community &> /dev/null; then
        brew services start mongodb-community
        echo -e "${GREEN}โ MongoDB ูุนูู ุนุจุฑ Homebrew${NC}"
    else
        echo -e "${RED}โ MongoDB ุบูุฑ ูุซุจุช${NC}"
        echo -e "${YELLOW}ูุชุซุจูุช MongoDB:${NC}"
        echo "  brew install mongodb-community"
    fi
}

# ุฏุงูุฉ ุนุฑุถ ุงูุญุงูุฉ
show_status() {
    echo -e "${BLUE}๐ ุญุงูุฉ ุงูุฎูุงุฏู:${NC}"
    echo ""

    if lsof -ti:5001 &> /dev/null; then
        echo -e "${GREEN}โ Backend:  ูุนูู (ุงููููุฐ 5001)${NC}"
    else
        echo -e "${RED}โ Backend:  ูุชููู${NC}"
    fi

    if lsof -ti:3000 &> /dev/null; then
        echo -e "${GREEN}โ Frontend: ูุนูู (ุงููููุฐ 3000)${NC}"
    else
        echo -e "${RED}โ Frontend: ูุชููู${NC}"
    fi

    if pgrep mongod &> /dev/null; then
        echo -e "${GREEN}โ MongoDB:  ูุนูู${NC}"
    else
        echo -e "${YELLOW}โ MongoDB:  ูุชููู${NC}"
    fi
}

# ุฏุงูุฉ ุงูุชูุธูู
clean_files() {
    echo -e "${BLUE}๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ...${NC}"

    rm -rf backend/node_modules
    rm -rf frontend/node_modules
    rm -rf backend/uploads/*
    rm -f /tmp/nokhba_*.pid

    echo -e "${GREEN}โ ุชู ุงูุชูุธูู${NC}"
}

# ุฏุงูุฉ ุงููุณุงุนุฏุฉ
show_help() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}         ุฏููู ุงุณุชุฎุฏุงู ููุตุฉ ูุฎุจุฉ         ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo "ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:"
    echo ""
    echo "  ./cf start       - ุชุดุบูู Backend ู Frontend ูุนุงู"
    echo "  ./cf backend     - ุชุดุบูู Backend ููุท"
    echo "  ./cf frontend    - ุชุดุบูู Frontend ููุท"
    echo "  ./cf stop        - ุฅููุงู ุฌููุน ุงูุฎูุงุฏู"
    echo "  ./cf install     - ุชุซุจูุช ุฌููุน ุงูุญุฒู"
    echo "  ./cf mongodb     - ุชุดุบูู MongoDB"
    echo "  ./cf status      - ุนุฑุถ ุญุงูุฉ ุงูุฎูุงุฏู"
    echo "  ./cf clean       - ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ"
    echo "  ./cf help        - ุนุฑุถ ูุฐู ุงููุณุงุนุฏุฉ"
    echo ""
    echo "ุงูุฑูุงุจุท:"
    echo "  Frontend:  http://localhost:3000"
    echo "  Backend:   http://localhost:5001"
    echo "  Excellence: http://localhost:3000/excellence"
    echo ""
    echo "ููุงุญุธุงุช:"
    echo "  - ุชุฃูุฏ ูู ุชุซุจูุช Node.js ู npm"
    echo "  - MongoDB ุงุฎุชูุงุฑู ููุชุทููุฑ"
    echo "  - ุงุณุชุฎุฏู Ctrl+C ูุฅููุงู ุงูุฎูุงุฏู ูุฏููุงู"
    echo ""
}

# ุงููุนุงูุฌ ุงูุฑุฆูุณู
case "$1" in
    start)
        echo -e "${BLUE}๐ ุชุดุบูู ุงููุดุฑูุน ูุงููุงู...${NC}"
        start_backend
        sleep 2
        start_frontend
        echo ""
        echo -e "${GREEN}โ ุงููุดุฑูุน ูุนูู ุงูุขู!${NC}"
        echo -e "${GREEN}  Frontend: http://localhost:3000${NC}"
        echo -e "${GREEN}  Backend:  http://localhost:5001${NC}"
        echo ""
        echo -e "${YELLOW}ุงุถุบุท Ctrl+C ูุฅููุงู ุงูุฎูุงุฏู${NC}"
        wait
        ;;

    backend)
        start_backend
        wait
        ;;

    frontend)
        start_frontend
        wait
        ;;

    stop)
        stop_servers
        ;;

    install)
        install_packages
        ;;

    mongodb)
        start_mongodb
        ;;

    status)
        show_status
        ;;

    clean)
        clean_files
        ;;

    help)
        show_help
        ;;

    *)
        if [ -z "$1" ]; then
            show_menu
        else
            echo -e "${RED}ุฃูุฑ ุบูุฑ ูุนุฑูู: $1${NC}"
            echo ""
            show_help
        fi
        ;;
esac
